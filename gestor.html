<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Final Version Perfected</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {}
                }
            }
        }
    </script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes zoomIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        @keyframes slideInRight { from { transform: translateX(1rem); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes slideInBottom { from { transform: translateY(0.5rem); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes slideInTop { from { transform: translateY(-0.5rem); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes pulseLeaf { 0% { transform: scale(1); } 50% { transform: scale(1.15); } 100% { transform: scale(1); } }
        
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
        .animate-zoom-in { animation: zoomIn 0.2s ease-out forwards; }
        .animate-slide-right { animation: slideInRight 0.3s ease-out forwards; }
        .animate-slide-bottom { animation: slideInBottom 0.3s ease-out forwards; }
        .animate-slide-top { animation: slideInTop 0.2s ease-out forwards; }
        .animate-pulse-leaf { animation: pulseLeaf 2s infinite ease-in-out; display: inline-block; }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body id="app-body" class="min-h-screen font-sans flex flex-col items-center py-6 sm:py-10 px-3 sm:px-4 transition-colors duration-500">
    
    <!-- CONTENEDOR PRINCIPAL -->
    <div class="w-full max-w-2xl bg-white/80 backdrop-blur-md dark:bg-stone-900/90 shadow-xl p-4 sm:p-8 rounded-lg transition-all duration-300 border" id="main-card">
        
        <!-- HEADER -->
        <header class="mb-6 flex flex-col sm:flex-row sm:justify-between sm:items-end gap-4 pb-4 transition-all" id="app-header">
            <!-- Renderizado por JS -->
        </header>

        <!-- PLATOS -->
        <div class="mb-6 pb-6 border-b transition-all" id="plates-section">
            <!-- Renderizado por JS -->
        </div>

        <!-- FASE DINÃMICA -->
        <div id="phase-container" class="transition-all">
            <!-- Renderizado por JS -->
        </div>
    </div>

    <!-- LISTA LARGA / AGENDA -->
    <div class="w-full max-w-2xl mt-8 transition-all" id="long-list-section">
        <!-- Renderizado por JS -->
    </div>

    <!-- ESTADÃSTICAS Y DIARIO -->
    <div class="w-full max-w-2xl mt-8 mb-12 transition-all" id="stats-section">
        <!-- Renderizado por JS -->
    </div>

    <!-- LÃ“GICA DE LA APLICACIÃ“N -->
    <script>
        // --- CONFIGURACIÃ“N DE TEMAS ---
        const themeConfig = {
            autumn: {
                name: 'OtoÃ±o', icon: 'ðŸ',
                bgMain: 'bg-orange-700', bgHover: 'hover:bg-orange-800',
                textMain: 'text-orange-700', textDark: 'dark:text-orange-400',
                borderMain: 'border-orange-200', borderDark: 'dark:border-orange-800',
                fillMain: 'fill-orange-700', fillDark: 'dark:fill-orange-500',
                lightBg: 'bg-orange-100', darkBg: 'dark:bg-orange-900/30',
                grad: 'bg-gradient-to-br from-amber-50 via-stone-50 to-orange-100 dark:from-stone-950 dark:via-orange-950/10 dark:to-stone-900',
                btnText: 'text-orange-800', darkBtnText: 'dark:text-orange-300'
            },
            ocean: {
                name: 'OcÃ©ano', icon: 'ðŸŒŠ',
                bgMain: 'bg-blue-600', bgHover: 'hover:bg-blue-700',
                textMain: 'text-blue-600', textDark: 'dark:text-blue-400',
                borderMain: 'border-blue-200', borderDark: 'dark:border-blue-800',
                fillMain: 'fill-blue-600', fillDark: 'dark:fill-blue-500',
                lightBg: 'bg-blue-100', darkBg: 'dark:bg-blue-900/30',
                grad: 'bg-gradient-to-br from-cyan-50 via-slate-50 to-blue-100 dark:from-slate-950 dark:via-blue-950/10 dark:to-slate-900',
                btnText: 'text-blue-800', darkBtnText: 'dark:text-blue-300'
            },
            forest: {
                name: 'Bosque', icon: 'ðŸŒ²',
                bgMain: 'bg-emerald-600', bgHover: 'hover:bg-emerald-700',
                textMain: 'text-emerald-600', textDark: 'dark:text-emerald-400',
                borderMain: 'border-emerald-200', borderDark: 'dark:border-emerald-800',
                fillMain: 'fill-emerald-600', fillDark: 'dark:fill-emerald-500',
                lightBg: 'bg-emerald-100', darkBg: 'dark:bg-emerald-900/30',
                grad: 'bg-gradient-to-br from-green-50 via-zinc-50 to-emerald-100 dark:from-zinc-950 dark:via-emerald-950/10 dark:to-zinc-900',
                btnText: 'text-emerald-800', darkBtnText: 'dark:text-emerald-300'
            },
            monochrome: {
                name: 'Monocromo', icon: 'âš™ï¸',
                bgMain: 'bg-zinc-700', bgHover: 'hover:bg-zinc-800',
                textMain: 'text-zinc-700', textDark: 'dark:text-zinc-400',
                borderMain: 'border-zinc-300', borderDark: 'dark:border-zinc-700',
                fillMain: 'fill-zinc-700', fillDark: 'dark:fill-zinc-500',
                lightBg: 'bg-zinc-200', darkBg: 'dark:bg-zinc-800/30',
                grad: 'bg-gradient-to-br from-zinc-100 via-white to-zinc-200 dark:from-zinc-950 dark:via-black dark:to-zinc-900',
                btnText: 'text-zinc-800', darkBtnText: 'dark:text-zinc-300'
            }
        };

        const themeKeys = Object.keys(themeConfig);

        // --- UTILIDADES ---
        const getToday = () => new Date().toISOString().split('T')[0];
        const getYesterday = () => {
            const d = new Date();
            d.setDate(d.getDate() - 1);
            return d.toISOString().split('T')[0];
        };
        const getFutureDate = (days) => {
            const d = new Date();
            d.setDate(d.getDate() + days);
            return d.toISOString().split('T')[0];
        };
        const escapeHTML = (str) => {
            if (!str) return '';
            return str.replace(/[&<>'"]/g, 
                tag => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', "'": '&#39;', '"': '&quot;' }[tag])
            );
        };

        const getTrafficLight = (lastActionDate, hasPendingTasks = true) => {
            if (!hasPendingTasks) return { color: 'bg-emerald-500', text: 'Al dÃ­a' };
            if (lastActionDate === getToday()) return { color: 'bg-emerald-500', text: 'Al dÃ­a' };
            if (lastActionDate === getYesterday()) return { color: 'bg-amber-500', text: 'Ayer' };
            return { color: 'bg-rose-500', text: 'Inactivo' };
        };

        const playTone = (frequency, type = 'sine', duration = 0.1, volume = 0.1) => {
            try {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                if (!AudioContext) return;
                const ctx = new AudioContext();
                const osc = ctx.createOscillator();
                const gainNode = ctx.createGain();
                osc.type = type;
                osc.frequency.setValueAtTime(frequency, ctx.currentTime);
                gainNode.gain.setValueAtTime(volume, ctx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + duration);
                osc.connect(gainNode);
                gainNode.connect(ctx.destination);
                osc.start();
                osc.stop(ctx.currentTime + duration);
            } catch (e) {}
        };

        const playAlarmTone = () => {
            for (let i = 0; i < 3; i++) {
                setTimeout(() => playTone(800, 'sine', 0.2, 0.1), i * 400);
                setTimeout(() => playTone(1000, 'sine', 0.2, 0.1), i * 400 + 200);
            }
        };

        const sendNotification = (title, options) => {
            if ("Notification" in window && Notification.permission === "granted") {
                new Notification(title, options);
            }
        };

        const requestNotificationPermission = () => {
            if ("Notification" in window && Notification.permission !== "denied" && Notification.permission !== "granted") {
                Notification.requestPermission();
            }
        };

        // --- ESTRUCTURA DE DATOS ---
        const createNewTask = (text, plateId, scheduledDate = null, recurrence = '') => ({
            id: crypto.randomUUID(),
            text,
            status: 'todo',
            skipCount: 0,
            createdAt: Date.now(),
            plateId,
            scheduledDate,
            recurrence, 
            notes: '',
            estimatedTime: 0,
            timeSpent: 0,
            completedAt: null,
            blockedBy: '' // Feature 7: Dependencias
        });

        const initialState = {
            tasks: [],
            chain: [],
            plates: [],
            currentPlateId: null,
            mode: 'capture',
            candidateIndex: 0,
            fastFVP: false,
            isDarkMode: false,
            zenMode: false,
            listTab: 'all',
            theme: 'autumn', // Feature 9: Selector de temas
            excludedPlatesForRound: [],
            journal: {}, // Feature 10: Diario
            stats: {
                maxChain: 0, selectYes: 0, selectNo: 0,
                pomodoroDate: getToday(), pomodorosToday: 0, pomodoroMinutesToday: 0,
                pomodoroMinutesByPlate: {}, reenteredDate: getToday(), reenteredToday: 0
            }
        };

        let state = { ...initialState };
        
        let editingTaskId = null;
        let showScheduleMenu = false;
        let showCustomDate = false;
        let showAdvancedStats = false;
        let customDateValue = getToday();
        let expandedNotes = {}; 
        let showJournalInput = false;
        
        let pomodoroDuration = 25 * 60;
        let pomodoroLeft = 25 * 60;
        let isPomodoroRunning = false;
        let isPomodoroAlarm = false;
        let showCustomPomodoro = false;
        let pomodoroInterval = null;
        let pomodoroElapsedSeconds = 0; 

        // Cargar desde LocalStorage
        function loadState() {
            try {
                const localData = localStorage.getItem('fvp_app_state_vanilla_v3');
                if (localData) {
                    const parsed = JSON.parse(localData);
                    if (!parsed.plates) { parsed.plates = []; parsed.currentPlateId = null; }
                    if (!parsed.stats) { parsed.stats = initialState.stats; }
                    if (!parsed.excludedPlatesForRound) parsed.excludedPlatesForRound = [];
                    if (!parsed.journal) parsed.journal = {};
                    if (!parsed.theme) parsed.theme = 'autumn';
                    parsed.tasks.forEach(t => {
                        if (t.blockedBy === undefined) t.blockedBy = '';
                    });
                    state = parsed;
                }
            } catch (e) { console.error("Error cargando estado", e); }
        }

        function saveState() {
            localStorage.setItem('fvp_app_state_vanilla_v3', JSON.stringify(state));
        }

        function findNextTodoIndex(startIndex) {
            const todayStr = getToday();
            for (let i = startIndex; i < state.tasks.length; i++) {
                const t = state.tasks[i];
                const isScheduledForFuture = t.scheduledDate && t.scheduledDate > todayStr;
                const isExcluded = state.excludedPlatesForRound && state.excludedPlatesForRound.includes(t.plateId);
                const isBlocked = t.blockedBy && state.tasks.some(x => x.id === t.blockedBy && x.status !== 'done');
                
                if (t.status === 'todo' && !isScheduledForFuture && !isExcluded && !isBlocked) return i;
            }
            return -1;
        }

        // --- MOTOR DE REDUCER / ACCIONES ---
        window.dispatch = function(action) {
            switch (action.type) {
                case 'TOGGLE_DARK_MODE':
                    state.isDarkMode = !state.isDarkMode;
                    document.documentElement.classList.toggle('dark', state.isDarkMode);
                    break;
                case 'CYCLE_THEME':
                    const currIndex = themeKeys.indexOf(state.theme);
                    state.theme = themeKeys[(currIndex + 1) % themeKeys.length];
                    break;
                case 'TOGGLE_FAST_FVP':
                    state.fastFVP = !state.fastFVP;
                    break;
                case 'TOGGLE_ZEN_MODE':
                    state.zenMode = !state.zenMode;
                    break;
                case 'SET_LIST_TAB':
                    state.listTab = action.payload;
                    break;
                case 'ADD_PLATE':
                    const newPlate = { id: crypto.randomUUID(), name: action.payload, dailyGoal: '', lastActionDate: null };
                    state.plates.push(newPlate);
                    if (state.plates.length === 1) state.currentPlateId = newPlate.id;
                    break;
                case 'SET_CURRENT_PLATE':
                    state.currentPlateId = action.payload;
                    break;
                case 'UPDATE_PLATE_GOAL':
                    const p = state.plates.find(p => p.id === action.payload.id);
                    if (p) p.dailyGoal = action.payload.goal;
                    break;
                case 'ADD_TASK':
                    state.tasks.push(createNewTask(action.payload.text, action.payload.plateId, null, action.payload.recurrence));
                    break;
                case 'ADD_URGENT_TASK':
                    const uTask = createNewTask(action.payload.text, action.payload.plateId, null, action.payload.recurrence);
                    state.tasks.push(uTask);
                    state.chain.push(uTask.id);
                    state.mode = 'action';
                    break;
                case 'START_FILTER':
                    state.mode = 'filter';
                    state.excludedPlatesForRound = []; 
                    break;
                case 'TOGGLE_PLATE_FILTER':
                    const pid = action.payload;
                    if (state.excludedPlatesForRound.includes(pid)) {
                        state.excludedPlatesForRound = state.excludedPlatesForRound.filter(id => id !== pid);
                    } else {
                        state.excludedPlatesForRound.push(pid);
                    }
                    break;
                case 'CANCEL_FILTER':
                    state.mode = 'capture';
                    state.excludedPlatesForRound = [];
                    break;
                case 'START_SELECTION':
                    const firstTodo = findNextTodoIndex(0);
                    if (firstTodo === -1) {
                        alert("No hay tareas listas para hacer (pueden estar bloqueadas o programadas).");
                        state.mode = 'capture';
                        break;
                    }
                    const anchor = state.tasks[firstTodo];
                    const nextCandidate = findNextTodoIndex(firstTodo + 1);
                    if (nextCandidate === -1) {
                        state.chain = [anchor.id];
                        state.mode = 'action';
                    } else {
                        state.chain = [anchor.id];
                        state.candidateIndex = nextCandidate;
                        state.mode = 'select';
                    }
                    break;
                case 'SELECT_YES':
                    const cTask = state.tasks[state.candidateIndex];
                    state.chain.push(cTask.id);
                    state.stats.selectYes++;
                    state.stats.maxChain = Math.max(state.stats.maxChain, state.chain.length);
                    
                    if (state.fastFVP) {
                        state.mode = 'action';
                    } else {
                        const nextIdY = findNextTodoIndex(state.candidateIndex + 1);
                        if (nextIdY === -1) state.mode = 'action';
                        else state.candidateIndex = nextIdY;
                    }
                    break;
                case 'SELECT_NO':
                    state.tasks[state.candidateIndex].skipCount++;
                    state.stats.selectNo++;
                    const nextIdN = findNextTodoIndex(state.candidateIndex + 1);
                    if (nextIdN === -1) state.mode = 'action';
                    else state.candidateIndex = nextIdN;
                    break;
                case 'FINISH_CURRENT_TASK':
                    finishCurrentTask();
                    break;
                case 'REENTER_CURRENT_TASK':
                    reenterCurrentTask(action.payload?.scheduledDate);
                    break;
                case 'POMODORO_COMPLETED':
                    handlePomodoroCompleted(action.payload.minutes, action.payload.plateId);
                    break;
                case 'DELETE_TASK':
                    state.tasks = state.tasks.filter(t => t.id !== action.payload);
                    break;
                case 'DISMISS_TASK':
                    const dt = state.tasks.find(t => t.id === action.payload);
                    if (dt) dt.status = 'dismissed';
                    break;
                case 'EDIT_TASK':
                    const et = state.tasks.find(t => t.id === action.payload.id);
                    if (et) {
                        if (action.payload.text !== undefined) et.text = action.payload.text;
                        if (action.payload.notes !== undefined) et.notes = action.payload.notes;
                        if (action.payload.blockedBy !== undefined) et.blockedBy = action.payload.blockedBy;
                    }
                    break;
                case 'SAVE_JOURNAL':
                    state.journal[getToday()] = action.payload;
                    showJournalInput = false;
                    break;
                case 'CLEAR_HISTORY':
                    state.tasks = state.tasks.filter(t => t.status === 'todo');
                    break;
                case 'FACTORY_RESET':
                    state = { ...initialState, plates: [], tasks: [], stats: { ...initialState.stats }, journal: {} };
                    break;
                case 'IMPORT_TXT':
                    importFromTxt(action.payload);
                    break;
            }
            saveState();
            renderApp();
        };

        function finishCurrentTask() {
            const cid = state.chain[state.chain.length - 1];
            const tIdx = state.tasks.findIndex(t => t.id === cid);
            const task = state.tasks[tIdx];
            
            task.status = 'done';
            task.completedAt = getToday();
            
            const pIdx = state.plates.findIndex(p => p.id === task.plateId);
            if(pIdx !== -1) state.plates[pIdx].lastActionDate = getToday();

            if (task.recurrence) {
                let nextDate = new Date();
                if (task.recurrence === 'daily') nextDate.setDate(nextDate.getDate() + 1);
                else if (task.recurrence === 'weekly') nextDate.setDate(nextDate.getDate() + 7);
                else if (task.recurrence === 'monthly') nextDate.setMonth(nextDate.getMonth() + 1);
                
                const recTask = createNewTask(task.text, task.plateId, nextDate.toISOString().split('T')[0], task.recurrence);
                recTask.notes = task.notes; 
                recTask.estimatedTime = task.estimatedTime;
                recTask.blockedBy = ''; // Desvincular bloqueo en la copia
                state.tasks.push(recTask);
            }

            state.chain.pop();
            const nextIdx = findNextTodoIndex(tIdx + 1);

            if (nextIdx !== -1 && state.chain.length > 0) {
                state.candidateIndex = nextIdx;
                state.mode = 'select';
            } else if (state.chain.length > 0) {
                state.mode = 'action';
            } else {
                state.mode = 'capture';
                state.zenMode = false;
                state.excludedPlatesForRound = []; 
            }
        }

        function reenterCurrentTask(scheduledDate) {
            const cid = state.chain[state.chain.length - 1];
            const tIdx = state.tasks.findIndex(t => t.id === cid);
            const task = state.tasks[tIdx];
            
            const isToday = state.stats.reenteredDate === getToday();
            state.stats.reenteredToday = isToday ? state.stats.reenteredToday + 1 : 1;
            state.stats.reenteredDate = getToday();

            state.tasks[tIdx].status = 'done';
            state.tasks[tIdx].completedAt = getToday();
            
            const newTask = createNewTask(task.text, task.plateId, scheduledDate || null, task.recurrence);
            newTask.timeSpent = task.timeSpent || 0; 
            newTask.estimatedTime = task.estimatedTime || 0;
            newTask.notes = task.notes || '';
            newTask.blockedBy = task.blockedBy || '';
            state.tasks.push(newTask);

            const pIdx = state.plates.findIndex(p => p.id === task.plateId);
            if(pIdx !== -1) state.plates[pIdx].lastActionDate = getToday();

            state.chain.pop();
            const nextIdx = findNextTodoIndex(tIdx + 1);

            if (nextIdx !== -1 && state.chain.length > 0) {
                state.candidateIndex = nextIdx;
                state.mode = 'select';
            } else if (state.chain.length > 0) {
                state.mode = 'action';
            } else {
                state.mode = 'capture';
                state.zenMode = false; 
                state.excludedPlatesForRound = []; 
            }
        }

        function handlePomodoroCompleted(minutes, plateId) {
            const isToday = state.stats.pomodoroDate === getToday();
            state.stats.pomodorosToday = isToday ? state.stats.pomodorosToday + 1 : 1;
            state.stats.pomodoroMinutesToday = isToday ? state.stats.pomodoroMinutesToday + minutes : minutes;
            state.stats.pomodoroDate = getToday();
            
            const pId = plateId || 'unassigned';
            if (!state.stats.pomodoroMinutesByPlate) state.stats.pomodoroMinutesByPlate = {};
            state.stats.pomodoroMinutesByPlate[pId] = (state.stats.pomodoroMinutesByPlate[pId] || 0) + minutes;
        }

        // --- FUNCIONES INTERFAZ DE USUARIO ---
        window.handleAddTaskSubmit = function(e) {
            e.preventDefault();
            const input = document.getElementById('new-task-input');
            const select = document.getElementById('plate-select');
            const recSelect = document.getElementById('recurrence-select');
            if (input.value.trim() && state.plates.length > 0) {
                window.dispatch({ 
                    type: 'ADD_TASK', 
                    payload: { text: input.value.trim(), plateId: select.value, recurrence: recSelect.value } 
                });
                renderPhase();
                renderList();
                renderStats();
                lucide.createIcons();
                setTimeout(() => document.getElementById('new-task-input').focus(), 10);
            }
        };

        window.handleAddUrgentClick = function() {
            const input = document.getElementById('new-task-input');
            const select = document.getElementById('plate-select');
            const recSelect = document.getElementById('recurrence-select');
            if (input.value.trim() && state.plates.length > 0) {
                window.dispatch({ 
                    type: 'ADD_URGENT_TASK', 
                    payload: { text: input.value.trim(), plateId: select.value, recurrence: recSelect.value } 
                });
            }
        };

        window.handleAddPlateSubmit = function(e) {
            e.preventDefault();
            const input = document.getElementById('new-plate-input');
            if (input.value.trim()) {
                window.dispatch({ type: 'ADD_PLATE', payload: input.value.trim() });
            }
        };

        window.handleSelectYes = function() {
            playTone(600, 'sine', 0.15, 0.1);
            window.dispatch({ type: 'SELECT_YES' });
        };
        window.handleSelectNo = function() {
            playTone(300, 'triangle', 0.15, 0.05);
            window.dispatch({ type: 'SELECT_NO' });
        };

        window.startEditingTask = function(id, text) {
            editingTaskId = id;
            renderList();
            setTimeout(() => {
                const el = document.getElementById('edit-input-' + id);
                if(el) { el.focus(); el.value = ''; el.value = text; }
            }, 10);
        };
        window.cancelEditingTask = function() {
            editingTaskId = null;
            renderList();
        };
        window.saveEditingTask = function(id) {
            const input = document.getElementById('edit-input-' + id);
            const select = document.getElementById('edit-blockedBy-' + id);
            if (input && input.value.trim()) {
                window.dispatch({ type: 'EDIT_TASK', payload: { id, text: input.value.trim(), blockedBy: select ? select.value : '' } });
            }
            editingTaskId = null;
            renderList();
        };
        window.handleEditKeyDown = function(e, id) {
            if (e.key === 'Enter') window.saveEditingTask(id);
            if (e.key === 'Escape') window.cancelEditingTask();
        };

        window.toggleNotes = function(id) {
            expandedNotes[id] = !expandedNotes[id];
            renderList();
            lucide.createIcons();
            if (expandedNotes[id]) {
                setTimeout(() => {
                    const ta = document.getElementById(`notes-area-${id}`);
                    if(ta) ta.focus();
                }, 10);
            }
        };
        window.saveNotes = function(id) {
            const ta = document.getElementById(`notes-area-${id}`);
            if (ta) {
                window.dispatch({ type: 'EDIT_TASK', payload: { id, notes: ta.value } });
            }
        };
        
        window.saveJournal = function() {
            const text = document.getElementById('journal-input').value;
            window.dispatch({ type: 'SAVE_JOURNAL', payload: text });
        };

        // --- POMODORO LOGIC ---
        function runPomodoro() {
            pomodoroElapsedSeconds++;
            if (pomodoroLeft > 0) {
                pomodoroLeft--;
            } else if (pomodoroLeft === 0 && !isPomodoroAlarm) {
                isPomodoroAlarm = true;
                playAlarmTone();
                sendNotification("Â¡Tiempo terminado!", { body: "El contador progresivo ha comenzado.", icon: "https://cdn-icons-png.flaticon.com/512/2950/2950664.png" });
                pomodoroLeft--; 
            } else {
                pomodoroLeft--; 
            }
            updatePomodoroUI();
        }

        window.togglePomodoro = function() {
            isPomodoroRunning = !isPomodoroRunning;
            if (isPomodoroRunning) {
                requestNotificationPermission();
                if (state.mode === 'action' && pomodoroLeft === pomodoroDuration && !isPomodoroAlarm) {
                    const currentTaskId = state.chain[state.chain.length - 1];
                    const activeTask = state.tasks.find(t => t.id === currentTaskId);
                    if (activeTask && !activeTask.estimatedTime) {
                        activeTask.estimatedTime = pomodoroDuration / 60;
                        saveState();
                    }
                }
                if(pomodoroInterval) clearInterval(pomodoroInterval);
                pomodoroInterval = setInterval(runPomodoro, 1000);
            } else {
                clearInterval(pomodoroInterval);
            }
            renderPhase(); 
        };

        window.handlePomodoroChange = function(minutes) {
            if (!minutes || isNaN(minutes) || minutes <= 0) return;
            pomodoroDuration = minutes * 60;
            pomodoroLeft = minutes * 60;
            pomodoroElapsedSeconds = 0;
            isPomodoroRunning = false;
            isPomodoroAlarm = false;
            showCustomPomodoro = false;
            clearInterval(pomodoroInterval);
            renderPhase();
        };

        function formatTime(seconds) {
            const isNegative = seconds < 0;
            const absSec = Math.abs(seconds);
            const m = Math.floor(absSec / 60);
            const s = absSec % 60;
            const timeStr = `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
            return isNegative ? `+ ${timeStr}` : timeStr;
        }

        window.submitCustomPomodoro = function(e) {
            e.preventDefault();
            const val = document.getElementById('custom-pom-input').value;
            window.handlePomodoroChange(Number(val));
        };

        window.stopPomodoroOnTaskEnd = function() {
            clearInterval(pomodoroInterval);
            isPomodoroRunning = false;
            isPomodoroAlarm = false;
            
            const minutesElapsed = Math.round(pomodoroElapsedSeconds / 60);
            if (minutesElapsed > 0 && state.mode === 'action') {
                const currentTaskId = state.chain[state.chain.length - 1];
                const activeTask = state.tasks.find(t => t.id === currentTaskId);
                if (activeTask) {
                    activeTask.timeSpent = (activeTask.timeSpent || 0) + minutesElapsed;
                    const plateForPomo = activeTask.plateId;
                    window.dispatch({ type: 'POMODORO_COMPLETED', payload: { minutes: minutesElapsed, plateId: plateForPomo } });
                }
            }
            
            pomodoroElapsedSeconds = 0;
            pomodoroLeft = pomodoroDuration; 
        };

        // --- IMPORT/EXPORT CSV ---
        window.handleExportCSV = function() {
            const headers = ['ID', 'Texto', 'Contexto', 'Estado', 'Creado', 'Completado', 'Programado', 'Recurrencia', 'Min. Estimados', 'Min. Invertidos', 'Notas', 'Dependencia'];
            const rows = state.tasks.map(t => {
                const plateName = state.plates.find(p => p.id === t.plateId)?.name || '';
                const depName = state.tasks.find(x => x.id === t.blockedBy)?.text || '';
                return [
                    t.id, 
                    `"${t.text.replace(/"/g, '""')}"`, 
                    `"${plateName}"`,
                    t.status,
                    new Date(t.createdAt).toISOString().split('T')[0],
                    t.completedAt || '',
                    t.scheduledDate || '',
                    t.recurrence || '',
                    t.estimatedTime || 0,
                    t.timeSpent || 0,
                    `"${(t.notes || '').replace(/"/g, '""')}"`,
                    `"${depName.replace(/"/g, '""')}"`
                ].join(',');
            });
            const csvContent = [headers.join(','), ...rows].join('\n');
            const blob = new Blob(["\uFEFF"+csvContent], { type: 'text/csv;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'fvp-metricas.csv';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        };

        function getStreak() {
            const doneTasks = state.tasks.filter(t => t.status === 'done' && t.completedAt);
            const uniqueDates = [...new Set(doneTasks.map(t => t.completedAt))].sort((a,b) => b.localeCompare(a));
            let streak = 0;
            const todayStr = getToday();
            const yesterdayStr = getYesterday();
            if (uniqueDates.includes(todayStr) || uniqueDates.includes(yesterdayStr)) {
                let checkDate = uniqueDates.includes(todayStr) ? new Date(todayStr) : new Date(yesterdayStr);
                while(true) {
                    if (uniqueDates.includes(checkDate.toISOString().split('T')[0])) {
                        streak++; checkDate.setDate(checkDate.getDate() - 1);
                    } else break;
                }
            }
            return streak;
        }

        // --- RENDERIZADO DOM ---
        function renderHeader() {
            const th = themeConfig[state.theme || 'autumn'];
            
            // Actualizar body theme
            document.getElementById('app-body').className = `min-h-screen font-sans flex flex-col items-center py-6 sm:py-10 px-3 sm:px-4 transition-colors duration-500 text-stone-800 dark:text-stone-100 ${th.grad}`;
            document.getElementById('main-card').className = `w-full max-w-2xl bg-white/80 backdrop-blur-md dark:bg-stone-900/90 shadow-xl p-4 sm:p-8 rounded-lg transition-all duration-300 border ${th.borderMain} dark:${th.borderDark} shadow-${th.color}-900/5`;

            const header = document.getElementById('app-header');
            header.style.display = state.zenMode ? 'none' : 'flex'; 
            if (state.zenMode) return;

            const streak = getStreak();
            const streakHtml = streak > 0 ? `
                <div class="flex items-center gap-1 ${th.lightBg} ${th.darkBg} px-3 py-1 rounded-full border ${th.borderMain} ${th.borderDark} animate-pulse-leaf" title="DÃ­as consecutivos productivos">
                    <span class="text-sm">${th.icon}</span>
                    <span class="text-xs font-bold ${th.btnText} ${th.darkBtnText}">Racha: ${streak}</span>
                </div>` : '';

            header.innerHTML = `
                <div>
                    <div class="flex items-center gap-3">
                        <h1 class="text-2xl font-semibold tracking-tight text-stone-900 dark:text-white">Final Version Perfected</h1>
                        ${streakHtml}
                    </div>
                    <p class="text-sm text-stone-500 dark:text-stone-400 mt-1">PreparaciÃ³n psicolÃ³gica antes que prioridad racional.</p>
                </div>
                <div class="flex items-center gap-4 w-full sm:w-auto justify-between sm:justify-end">
                    <label class="flex items-center gap-2 text-sm cursor-pointer select-none text-stone-600 dark:text-stone-300 hover:text-stone-900 dark:hover:text-white transition-colors">
                        <input type="checkbox" ${state.fastFVP ? 'checked' : ''} onchange="window.dispatch({type:'TOGGLE_FAST_FVP'})" class="accent-${th.color}-600 dark:accent-${th.color}-500"/>
                        Fast FVP
                    </label>
                    <div class="flex gap-1">
                        <button onclick="window.dispatch({type:'CYCLE_THEME'})" class="p-2 text-stone-500 dark:text-stone-400 hover:${th.textMain} dark:hover:text-white transition-colors rounded-sm hover:bg-stone-100 dark:hover:bg-stone-800" title="Cambiar tema visual">
                            <i data-lucide="palette" class="w-[18px] h-[18px]"></i>
                        </button>
                        <button onclick="window.dispatch({type:'TOGGLE_DARK_MODE'})" class="p-2 text-stone-500 dark:text-stone-400 hover:${th.textMain} dark:hover:text-white transition-colors rounded-sm hover:bg-stone-100 dark:hover:bg-stone-800" title="Alternar modo oscuro">
                            <i data-lucide="${state.isDarkMode ? 'sun' : 'moon'}" class="w-[18px] h-[18px]"></i>
                        </button>
                    </div>
                </div>
            `;
        }

        function renderPlates() {
            const th = themeConfig[state.theme || 'autumn'];
            const container = document.getElementById('plates-section');
            container.style.display = state.zenMode ? 'none' : 'block'; 
            if (state.zenMode) return;

            let platesHtml = state.plates.map(p => {
                const hasPendingTasks = state.tasks.some(t => t.status === 'todo' && t.plateId === p.id);
                const tl = getTrafficLight(p.lastActionDate, hasPendingTasks);
                const isActive = state.currentPlateId === p.id;
                return `
                <div class="flex flex-col items-center gap-1 cursor-pointer" onclick="window.dispatch({type:'SET_CURRENT_PLATE', payload:'${p.id}'})">
                    <div class="px-3 py-1.5 rounded-full text-sm font-medium transition-all ${isActive ? `${th.bgMain} text-white shadow-sm` : 'bg-stone-100 text-stone-600 dark:bg-stone-800 dark:text-stone-400 border border-transparent hover:bg-stone-200 dark:hover:bg-stone-700'}">
                        ${escapeHTML(p.name)}
                    </div>
                    <div class="flex items-center gap-1 text-[9px] text-stone-500 uppercase tracking-wider font-semibold">
                        <span class="w-2 h-2 rounded-full ${tl.color}"></span> ${tl.text}
                    </div>
                </div>`;
            }).join('');

            const cPlate = state.plates.find(p => p.id === state.currentPlateId);
            
            container.innerHTML = `
                <div class="flex items-center justify-between mb-3">
                    <h2 class="text-xs uppercase tracking-widest text-stone-400 dark:text-stone-500">Tus contextos / Platos</h2>
                </div>
                <div class="flex flex-wrap gap-3 items-center">
                    ${platesHtml}
                    <form onsubmit="window.handleAddPlateSubmit(event)" class="flex items-center w-full sm:w-auto mt-2 sm:mt-0">
                        <input type="text" id="new-plate-input" placeholder="+ Nuevo plato" class="text-sm bg-transparent border border-dashed border-stone-300 dark:border-stone-700 rounded-full px-3 py-1.5 w-full sm:w-32 outline-none focus:${th.borderMain} dark:focus:border-white dark:text-white transition-colors" />
                    </form>
                </div>
                ${state.currentPlateId ? `
                <div class="mt-5 bg-stone-100 dark:bg-stone-800/50 p-3 rounded-sm flex flex-col sm:flex-row sm:items-center gap-2">
                    <span class="text-xs font-semibold uppercase tracking-wider text-stone-500 dark:text-stone-400 shrink-0">Objetivo del dÃ­a (${escapeHTML(cPlate?.name)}):</span>
                    <input type="text" value="${escapeHTML(cPlate?.dailyGoal)}" onchange="window.dispatch({type:'UPDATE_PLATE_GOAL', payload:{id:'${state.currentPlateId}', goal:this.value}})" placeholder="Escribe aquÃ­ tu objetivo..." class="flex-1 w-full bg-transparent border-b border-stone-300 dark:border-stone-700 outline-none focus:${th.borderMain} dark:text-white text-sm px-1 py-1 sm:py-0.5 transition-colors"/>
                </div>` : ''}
            `;
        }

        function renderPhase() {
            const th = themeConfig[state.theme || 'autumn'];
            const container = document.getElementById('phase-container');
            const todayStr = getToday();
            
            if (state.mode === 'capture') {
                const globalActiveCount = state.tasks.filter(t => t.status === 'todo' && (!t.scheduledDate || t.scheduledDate <= todayStr)).length;
                let optionsHtml = state.plates.map(p => `<option value="${p.id}" ${state.currentPlateId === p.id ? 'selected' : ''}>${escapeHTML(p.name)}</option>`).join('');
                
                container.innerHTML = `
                <div class="animate-slide-bottom">
                    <form onsubmit="window.handleAddTaskSubmit(event)" class="flex flex-col gap-2 mb-8 w-full">
                        <div class="flex flex-col sm:flex-row gap-2">
                            <select id="plate-select" ${state.plates.length === 0 ? 'disabled' : ''} class="w-full sm:w-auto p-3 h-12 bg-stone-100 dark:bg-stone-800 border-none outline-none focus:ring-2 focus:ring-stone-300 rounded-sm dark:text-white text-sm shrink-0 cursor-pointer disabled:opacity-50">
                                ${state.plates.length === 0 ? '<option value="">Sin platos</option>' : optionsHtml}
                            </select>
                            <input id="new-task-input" type="text" placeholder="${state.plates.length === 0 ? 'AÃ±ade un plato primero...' : 'AÃ±ade cualquier tarea sin clasificar...'}" ${state.plates.length === 0 ? 'disabled' : ''} class="w-full sm:flex-1 p-3 h-12 bg-stone-100 dark:bg-stone-800 border-none outline-none focus:ring-2 focus:ring-stone-300 rounded-sm dark:text-white dark:placeholder-stone-400 disabled:opacity-50 transition-shadow" />
                        </div>
                        <div class="flex gap-2 w-full mt-1">
                            <select id="recurrence-select" ${state.plates.length === 0 ? 'disabled' : ''} class="flex-1 p-3 h-12 bg-stone-100 dark:bg-stone-800 border-none outline-none focus:ring-2 focus:ring-stone-300 rounded-sm dark:text-white text-sm cursor-pointer disabled:opacity-50">
                                <option value="">No repetir</option>
                                <option value="daily">Repetir diario</option>
                                <option value="weekly">Repetir semanal</option>
                                <option value="monthly">Repetir mensual</option>
                            </select>
                            <button type="submit" ${state.plates.length === 0 ? 'disabled' : ''} class="w-16 h-12 ${th.bgMain} text-white rounded-sm ${th.bgHover} transition-colors flex items-center justify-center disabled:opacity-50" title="AÃ±adir a la lista">
                                <i data-lucide="plus" class="w-5 h-5"></i>
                            </button>
                            <button type="button" onclick="window.handleAddUrgentClick()" ${state.plates.length === 0 ? 'disabled' : ''} class="flex-1 p-3 h-12 border border-rose-300 dark:border-rose-900 text-rose-600 dark:text-rose-400 rounded-sm hover:bg-rose-50 dark:hover:bg-rose-950/30 transition-colors flex items-center justify-center font-medium text-sm disabled:opacity-50" title="Marcar como urgente">
                                Urgente
                            </button>
                        </div>
                    </form>
                    ${state.plates.length > 0 && globalActiveCount > 0 ? `
                    <div class="text-center mt-8">
                        <button onclick="window.dispatch({type:'START_FILTER'})" class="h-12 ${th.bgMain} text-white px-8 rounded-sm font-medium tracking-wide ${th.bgHover} transition-transform active:scale-95 flex items-center justify-center gap-2 mx-auto w-full sm:w-auto shadow-sm hover:shadow-md">
                            <i data-lucide="play" class="w-[18px] h-[18px]"></i> Iniciar preselecciÃ³n
                        </button>
                        <p class="text-xs text-stone-500 mt-2">EvaluarÃ¡s todas las tareas pendientes</p>
                    </div>` : (state.plates.length > 0 ? `
                    <div class="text-center mt-8 text-sm text-stone-500 dark:text-stone-400">
                        No hay tareas pendientes en la lista para hoy.
                    </div>` : '')}
                </div>`;
            } 
            else if (state.mode === 'filter') {
                let platesHtml = state.plates.map(p => {
                    const isExcluded = state.excludedPlatesForRound.includes(p.id);
                    return `<button onclick="window.dispatch({type:'TOGGLE_PLATE_FILTER', payload:'${p.id}'})" class="px-4 py-3 sm:py-2 rounded-full text-sm font-medium transition-colors border ${isExcluded ? 'bg-stone-100 text-stone-400 border-stone-200 dark:bg-stone-800/50 dark:text-stone-500 dark:border-stone-800 line-through' : 'bg-emerald-50 text-emerald-700 border-emerald-200 dark:bg-emerald-900/20 dark:text-emerald-400 dark:border-emerald-800/50 hover:bg-emerald-100 shadow-sm'}">${escapeHTML(p.name)}</button>`;
                }).join('');
                
                container.innerHTML = `
                <div class="py-6 sm:py-10 flex flex-col items-center text-center animate-zoom-in">
                    <h2 class="text-stone-500 dark:text-stone-400 uppercase tracking-widest text-xs mb-4">Paso previo</h2>
                    <p class="text-base sm:text-lg text-stone-600 dark:text-stone-300 mb-2">Â¿Quieres descartar algÃºn plato para esta vuelta?</p>
                    <p class="text-xs text-stone-400 dark:text-stone-500 mb-8">Toca los platos que no puedas o no quieras hacer ahora.</p>
                    
                    <div class="flex flex-wrap gap-3 justify-center mb-10 w-full max-w-md">
                        ${platesHtml}
                    </div>

                    <button onclick="window.dispatch({type:'START_SELECTION'})" class="w-full sm:w-auto h-12 px-8 ${th.bgMain} text-white rounded-sm font-medium ${th.bgHover} transition-colors shadow-sm flex items-center justify-center gap-2">
                        <i data-lucide="play" class="w-[18px] h-[18px]"></i> Comenzar selecciÃ³n global
                    </button>
                    <button onclick="window.dispatch({type:'CANCEL_FILTER'})" class="mt-4 text-sm text-stone-500 hover:text-stone-700 dark:text-stone-400 dark:hover:text-stone-300 py-2">
                        Cancelar y volver
                    </button>
                </div>`;
            }
            else if (state.mode === 'select') {
                const cTask = state.tasks[state.candidateIndex];
                const anchorTask = state.tasks.find(t => t.id === state.chain[state.chain.length - 1]);
                const cTaskPlate = state.plates.find(p => p.id === cTask?.plateId)?.name || 'Varios';

                container.innerHTML = `
                <div class="py-6 sm:py-10 flex flex-col items-center text-center animate-zoom-in">
                    <h2 class="text-stone-500 dark:text-stone-400 uppercase tracking-widest text-xs mb-4 sm:mb-6">ComparaciÃ³n</h2>
                    <p class="text-base sm:text-lg text-stone-600 dark:text-stone-300 mb-6 sm:mb-8">Â¿Quieres o puedes hacer esto <strong class="text-stone-900 dark:text-white border-b border-stone-900 dark:border-white">ANTES</strong> que la tarea marcada?</p>
                    
                    <div class="bg-stone-100 dark:bg-stone-800 w-full p-5 sm:p-6 rounded-sm border border-stone-200 dark:border-stone-700 mb-6 sm:mb-8 relative">
                        <span class="absolute top-2 left-3 text-[10px] uppercase tracking-wider text-stone-400 dark:text-stone-500">${escapeHTML(cTaskPlate)}</span>
                        <span class="text-xs text-stone-400 dark:text-stone-500 block mb-2 mt-2">Tarea a evaluar:</span>
                        <p class="text-xl sm:text-2xl font-medium text-stone-900 dark:text-stone-100">${escapeHTML(cTask?.text)}</p>
                    </div>

                    <div class="opacity-50 flex flex-col sm:flex-row items-center gap-1 sm:gap-3 mb-8 sm:mb-12 text-center">
                        <span class="text-[10px] sm:text-xs uppercase tracking-widest text-stone-600 dark:text-stone-400">Marcada actual:</span>
                        <span class="line-through text-stone-600 dark:text-stone-400 text-sm sm:text-base">${escapeHTML(anchorTask?.text)}</span>
                    </div>

                    <div class="flex gap-3 sm:gap-4 w-full justify-center">
                        <button onclick="window.handleSelectNo()" class="flex-1 max-w-[200px] h-16 sm:h-auto p-3 sm:p-4 border border-stone-300 dark:border-stone-700 text-stone-600 dark:text-stone-300 hover:bg-stone-50 dark:hover:bg-stone-800 rounded-sm flex flex-col items-center gap-1 sm:gap-2 transition-colors">
                            <span class="font-semibold text-base sm:text-lg">No</span>
                            <span class="text-[10px] sm:text-xs opacity-50 hidden sm:block">Flecha abajo â†“</span>
                        </button>
                        <button onclick="window.handleSelectYes()" class="flex-1 max-w-[200px] h-16 sm:h-auto p-3 sm:p-4 ${th.bgMain} text-white ${th.bgHover} rounded-sm flex flex-col items-center gap-1 sm:gap-2 transition-colors shadow-md">
                            <span class="font-semibold text-base sm:text-lg">SÃ­, la marco</span>
                            <span class="text-[10px] sm:text-xs opacity-70 hidden sm:block">Flecha derecha â†’</span>
                        </button>
                    </div>
                </div>`;
            }
            else if (state.mode === 'action') {
                const aTask = state.tasks.find(t => t.id === state.chain[state.chain.length - 1]);
                const estText = aTask?.estimatedTime ? `${aTask.estimatedTime}m est.` : 'Sin est.';
                const realText = aTask?.timeSpent ? `${aTask.timeSpent}m real` : '';
                
                let statsBadge = '';
                if (aTask?.estimatedTime || aTask?.timeSpent) {
                    statsBadge = `<span class="inline-flex items-center gap-1 text-xs ${th.lightBg} ${th.darkBg} ${th.btnText} ${th.darkBtnText} px-2 py-0.5 rounded-sm ml-2 align-middle font-normal"><i data-lucide="activity" class="w-3 h-3"></i>${estText} ${realText ? '| '+realText : ''}</span>`;
                }
                
                const chainHtml = state.chain.map((id, index) => {
                    const t = state.tasks.find(tx => tx.id === id);
                    const isTop = index === state.chain.length - 1;
                    return `<div class="text-sm truncate pl-3 border-l-2 transition-all ${isTop ? `${th.borderMain} font-medium ${th.textMain} dark:text-white scale-105 origin-left` : 'border-stone-200 dark:border-stone-800 text-stone-400 dark:text-stone-500'}">${escapeHTML(t?.text)}</div>`;
                }).join('');

                const pBtnsHtml = [5, 15, 25, 50].map(min => `
                    <button onclick="window.handlePomodoroChange(${min})" class="text-xs px-3 py-1.5 rounded-sm transition-colors ${pomodoroDuration === min*60 ? `${th.bgMain} text-white` : `bg-stone-100 text-stone-600 hover:bg-stone-200 dark:bg-stone-800 dark:text-stone-400` }">${min}m</button>
                `).join('');

                const customPomHtml = showCustomPomodoro 
                    ? `<form onsubmit="window.submitCustomPomodoro(event)" class="flex items-center gap-1"><input type="number" min="1" id="custom-pom-input" class="w-14 text-xs px-2 py-1.5 rounded-sm bg-stone-100 dark:bg-stone-800 border border-stone-300 dark:border-stone-600 outline-none dark:text-white" placeholder="Min"/><button type="submit" class="text-xs ${th.bgMain} text-white px-3 py-1.5 rounded-sm">Ok</button></form>`
                    : `<button onclick="showCustomPomodoro=true; renderPhase(); lucide.createIcons(); setTimeout(()=>document.getElementById('custom-pom-input').focus(),10)" class="text-xs px-3 py-1.5 rounded-sm transition-colors ${![5,15,25,50].includes(pomodoroDuration/60) ? `${th.bgMain} text-white` : 'bg-stone-100 text-stone-600 hover:bg-stone-200 dark:bg-stone-800 dark:text-stone-400'}">Otro</button>`;

                const scheduleMenuHtml = showScheduleMenu ? `
                    <div class="absolute top-full right-0 mt-2 w-full sm:w-48 bg-white dark:bg-stone-900 border border-stone-200 dark:border-stone-700 shadow-lg rounded-sm z-10 p-1 flex flex-col gap-1 text-sm animate-zoom-in">
                        ${!showCustomDate ? `
                            <button onclick="window.stopPomodoroOnTaskEnd(); window.dispatch({type:'REENTER_CURRENT_TASK', payload:{scheduledDate:'${getFutureDate(1)}'}})" class="p-3 sm:p-2 text-left hover:bg-stone-100 dark:hover:bg-stone-800 rounded-sm text-stone-700 dark:text-stone-300">MaÃ±ana</button>
                            <button onclick="window.stopPomodoroOnTaskEnd(); window.dispatch({type:'REENTER_CURRENT_TASK', payload:{scheduledDate:'${getFutureDate(2)}'}})" class="p-3 sm:p-2 text-left hover:bg-stone-100 dark:hover:bg-stone-800 rounded-sm text-stone-700 dark:text-stone-300">En 2 dÃ­as</button>
                            <button onclick="window.stopPomodoroOnTaskEnd(); window.dispatch({type:'REENTER_CURRENT_TASK', payload:{scheduledDate:'${getFutureDate(3)}'}})" class="p-3 sm:p-2 text-left hover:bg-stone-100 dark:hover:bg-stone-800 rounded-sm text-stone-700 dark:text-stone-300">En 3 dÃ­as</button>
                            <button onclick="window.stopPomodoroOnTaskEnd(); window.dispatch({type:'REENTER_CURRENT_TASK', payload:{scheduledDate:'${getFutureDate(7)}'}})" class="p-3 sm:p-2 text-left hover:bg-stone-100 dark:hover:bg-stone-800 rounded-sm text-stone-700 dark:text-stone-300">En 1 semana</button>
                            <div class="h-px bg-stone-200 dark:bg-stone-700 my-1"></div>
                            <button onclick="showCustomDate=true; renderPhase(); lucide.createIcons();" class="p-3 sm:p-2 text-left hover:bg-stone-100 dark:hover:bg-stone-800 rounded-sm text-stone-700 dark:text-stone-300 font-medium">Elegir fecha...</button>
                        ` : `
                            <div class="p-2 flex flex-col gap-2">
                                <input type="date" value="${customDateValue}" onchange="customDateValue=this.value" class="w-full bg-stone-100 dark:bg-stone-800 text-stone-900 dark:text-white p-3 sm:p-2 rounded-sm outline-none border border-transparent focus:${th.borderMain}"/>
                                <div class="flex gap-1">
                                    <button onclick="window.stopPomodoroOnTaskEnd(); window.dispatch({type:'REENTER_CURRENT_TASK', payload:{scheduledDate:customDateValue}})" class="flex-1 ${th.bgMain} text-white p-2 rounded-sm">Guardar</button>
                                    <button onclick="showCustomDate=false; renderPhase(); lucide.createIcons();" class="flex-1 border border-stone-300 dark:border-stone-700 text-stone-600 dark:text-stone-400 p-2 rounded-sm">AtrÃ¡s</button>
                                </div>
                            </div>
                        `}
                    </div>` : '';

                const pct = isPomodoroAlarm || pomodoroLeft < 0 ? 100 : (pomodoroDuration>0 ? ((pomodoroDuration-pomodoroLeft)/pomodoroDuration)*100 : 0);
                const barColor = (isPomodoroAlarm || pomodoroLeft < 0) ? 'bg-rose-500 dark:bg-rose-500 animate-pulse' : th.bgMain;

                container.innerHTML = `
                <div class="py-4 sm:py-6 animate-slide-right">
                    <div class="flex flex-col sm:flex-row items-start gap-6">
                        ${state.zenMode ? '' : `
                        <div class="w-full sm:w-1/3 border-b sm:border-b-0 sm:border-r border-stone-200 dark:border-stone-800 pb-5 sm:pb-0 pr-0 sm:pr-6 flex flex-col">
                            <h3 class="text-xs uppercase tracking-widest text-stone-400 dark:text-stone-500 mb-4">Cadena de acciÃ³n</h3>
                            <div class="flex flex-col gap-3 max-h-32 sm:max-h-none overflow-y-auto">${chainHtml}</div>
                        </div>`}
                        <div class="w-full ${state.zenMode ? '' : 'sm:w-2/3'} pl-0 sm:pl-2">
                            <div class="flex items-center justify-between mb-4">
                                <h2 class="${th.textMain} ${th.textDark} uppercase tracking-widest text-xs flex items-center gap-2">
                                    <i data-lucide="arrow-right" class="w-3.5 h-3.5"></i> Haz esto ahora
                                </h2>
                                <button onclick="window.dispatch({type:'TOGGLE_ZEN_MODE'})" class="text-stone-400 hover:${th.textMain} transition-colors p-1 bg-stone-100 dark:bg-stone-800 rounded-sm" title="${state.zenMode ? 'Salir del modo enfoque' : 'Entrar en modo enfoque'}">
                                    <i data-lucide="${state.zenMode ? 'minimize' : 'maximize'}" class="w-4 h-4"></i>
                                </button>
                            </div>
                            
                            <p class="text-2xl sm:text-3xl font-medium leading-tight mb-8 sm:mb-10 text-stone-900 dark:text-white">
                                ${escapeHTML(aTask?.text)} ${statsBadge}
                            </p>
                            
                            <div class="flex flex-col gap-3">
                                <button onclick="window.stopPomodoroOnTaskEnd(); window.dispatch({type:'FINISH_CURRENT_TASK'})" class="w-full h-12 sm:h-auto p-3 sm:p-4 ${th.bgMain} text-white ${th.bgHover} rounded-sm flex items-center justify-center gap-2 font-medium shadow-sm">
                                    <i data-lucide="check-circle-2" class="w-[18px] h-[18px]"></i> Terminada
                                </button>
                                <div class="flex flex-col sm:flex-row gap-2 w-full">
                                    <button onclick="window.stopPomodoroOnTaskEnd(); window.dispatch({type:'REENTER_CURRENT_TASK'})" class="flex-1 h-12 p-3 border border-stone-300 dark:border-stone-700 text-stone-700 dark:text-stone-300 hover:bg-stone-50 dark:hover:bg-stone-800 rounded-sm flex items-center justify-center gap-2 font-medium" title="Reingresar al final">
                                        <i data-lucide="rotate-ccw" class="w-4 h-4"></i> Reingresar
                                    </button>
                                    <div class="relative flex-1">
                                        <button onclick="showScheduleMenu=!showScheduleMenu; renderPhase(); lucide.createIcons();" class="w-full h-12 p-3 border border-stone-300 dark:border-stone-700 text-stone-700 dark:text-stone-300 hover:bg-stone-50 dark:hover:bg-stone-800 rounded-sm flex items-center justify-center gap-2 font-medium transition-colors">
                                            <i data-lucide="calendar" class="w-4 h-4"></i> Programar...
                                        </button>
                                        ${scheduleMenuHtml}
                                    </div>
                                </div>
                            </div>

                            <div class="mt-8 p-4 sm:p-5 rounded-sm border transition-all duration-500 shadow-sm ${(isPomodoroAlarm || pomodoroLeft < 0) ? 'bg-rose-50 border-rose-400 dark:bg-rose-900/30 dark:border-rose-500 scale-[1.02]' : 'bg-white/90 dark:bg-stone-900/80 border-stone-200 dark:border-stone-800'}">
                                <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-3 mb-4">
                                    <h3 class="text-xs uppercase tracking-widest text-stone-500 dark:text-stone-400 font-semibold flex items-center gap-2">
                                        <i data-lucide="clock" class="w-3.5 h-3.5 text-amber-600 dark:text-amber-500"></i> Pomodoro
                                    </h3>
                                    <div class="flex flex-wrap gap-2 items-center justify-start sm:justify-end">
                                        ${pBtnsHtml} ${customPomHtml}
                                    </div>
                                </div>
                                <div class="w-full h-1.5 bg-stone-100 dark:bg-stone-800 rounded-full overflow-hidden mb-4">
                                    <div id="pomodoro-progress" class="h-full ${barColor} transition-all duration-1000 ease-linear" style="width: ${pct}%"></div>
                                </div>
                                <div class="flex items-center justify-between">
                                    <div id="pomodoro-display" class="text-4xl font-mono font-bold tracking-tight ${(isPomodoroAlarm || pomodoroLeft < 0) ? 'text-rose-600 dark:text-rose-400' : 'text-stone-900 dark:text-white'}">
                                        ${formatTime(pomodoroLeft)}
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <button onclick="window.togglePomodoro()" class="p-4 sm:p-3 rounded-full flex items-center justify-center transition-colors ${isPomodoroRunning ? 'bg-amber-100 text-amber-700 hover:bg-amber-200 dark:bg-amber-900/30 dark:text-amber-400' : 'bg-emerald-100 text-emerald-700 hover:bg-emerald-200 dark:bg-emerald-900/30 dark:text-emerald-400'}">
                                            ${isPomodoroRunning ? '<i data-lucide="pause" class="w-6 h-6 sm:w-5 sm:h-5"></i>' : '<i data-lucide="play" class="w-6 h-6 sm:w-5 sm:h-5 ml-1"></i>'}
                                        </button>
                                        <button onclick="window.handlePomodoroChange(pomodoroDuration/60)" class="p-4 sm:p-3 text-stone-500 hover:bg-stone-200 hover:text-stone-900 dark:bg-stone-800 dark:hover:text-white rounded-full transition-colors">
                                            <i data-lucide="rotate-ccw" class="w-6 h-6 sm:w-5 sm:h-5"></i>
                                        </button>
                                    </div>
                                </div>
                                ${(isPomodoroAlarm || pomodoroLeft < 0) ? `<p class="mt-3 text-sm text-rose-600 dark:text-rose-400 font-medium text-center bg-rose-100 dark:bg-rose-950/50 py-2 rounded-sm flex items-center justify-center gap-2"><i data-lucide="alert-circle" class="w-4 h-4"></i> Tiempo extra. Conteo progresivo.</p>` : ''}
                            </div>
                        </div>
                    </div>
                </div>`;
            }
        }

        function updatePomodoroUI() {
            const display = document.getElementById('pomodoro-display');
            const progress = document.getElementById('pomodoro-progress');
            if(display) display.innerText = formatTime(pomodoroLeft);
            if(progress) progress.style.width = `${isPomodoroAlarm || pomodoroLeft < 0 ? 100 : (pomodoroDuration>0 ? ((pomodoroDuration-pomodoroLeft)/pomodoroDuration)*100 : 0)}%`;
            if(isPomodoroAlarm) renderPhase(); 
        }

        function renderList() {
            const th = themeConfig[state.theme || 'autumn'];
            const container = document.getElementById('long-list-section');
            container.style.display = state.zenMode ? 'none' : 'block'; 
            if (state.zenMode) return;

            const todayStr = getToday();
            let tasksToRender = state.tasks;
            if (state.listTab === 'agenda') {
                tasksToRender = state.tasks.filter(t => t.scheduledDate && t.scheduledDate > todayStr && t.status === 'todo');
                tasksToRender.sort((a,b) => a.scheduledDate.localeCompare(b.scheduledDate));
            }

            const hasHistory = state.tasks.some(t => t.status === 'done' || t.status === 'dismissed');
            
            let listHtml = tasksToRender.length === 0 ? '<p class="text-stone-400 dark:text-stone-500 italic text-center py-6">No hay tareas en esta vista.</p>' : '';
            
            tasksToRender.forEach((task, idx) => {
                const tPlate = state.plates.find(p => p.id === task.plateId);
                const isChain = state.chain.includes(task.id);
                const isFuture = task.scheduledDate && task.scheduledDate > todayStr && task.status === 'todo';
                const isEditing = editingTaskId === task.id;
                const showNotes = expandedNotes[task.id];

                const statusClass = task.status === 'done' ? 'opacity-40 line-through' : (task.status === 'dismissed' ? 'opacity-40 bg-rose-50 dark:bg-rose-950/20 line-through text-rose-900 dark:text-rose-200' : 'hover:bg-stone-50 dark:hover:bg-stone-800/50');
                
                const recBadge = task.recurrence ? `<span class="inline-flex items-center gap-1 text-[10px] bg-stone-200 dark:bg-stone-700 text-stone-600 dark:text-stone-300 px-1.5 py-0.5 rounded-sm shrink-0"><i data-lucide="repeat" class="w-2.5 h-2.5"></i></span>` : '';
                const timeBadge = task.timeSpent ? `<span class="inline-flex items-center gap-1 text-[10px] ${th.lightBg} ${th.darkBg} ${th.btnText} ${th.darkBtnText} px-1.5 py-0.5 rounded-sm shrink-0"><i data-lucide="clock" class="w-2.5 h-2.5"></i>${task.timeSpent}m</span>` : '';
                const depBadge = task.blockedBy ? `<span class="inline-flex items-center gap-1 text-[10px] bg-rose-100 dark:bg-rose-900/30 text-rose-800 dark:text-rose-300 px-1.5 py-0.5 rounded-sm shrink-0" title="Depende de otra tarea"><i data-lucide="lock" class="w-2.5 h-2.5"></i></span>` : '';

                let editBlockedHtml = '';
                if (isEditing) {
                    const otherTasks = state.tasks.filter(t => t.id !== task.id && t.status === 'todo');
                    editBlockedHtml = `
                        <select id="edit-blockedBy-${task.id}" class="w-full text-xs p-1.5 mt-1 rounded-sm bg-stone-100 dark:bg-stone-800 border-none outline-none focus:ring-1 focus:ring-stone-300 dark:text-white">
                            <option value="">Sin dependencias</option>
                            ${otherTasks.map(t => `<option value="${t.id}" ${task.blockedBy === t.id ? 'selected' : ''}>Depende de: ${escapeHTML(t.text)}</option>`).join('')}
                        </select>
                    `;
                }

                listHtml += `
                <div class="flex flex-col p-3 sm:p-2 rounded-sm group transition-colors gap-2 sm:gap-0 ${statusClass}">
                    <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-2 sm:gap-0">
                        <div class="flex items-center gap-2 sm:gap-3 overflow-hidden flex-1">
                            <span class="text-stone-400 dark:text-stone-500 w-5 text-right text-xs shrink-0">${idx + 1}.</span>
                            ${isChain ? `<i data-lucide="circle" class="${th.fillMain} ${th.textMain} ${th.fillDark} shrink-0 w-2.5 h-2.5"></i>` : '<div class="w-2.5 shrink-0"></div>'}
                            
                            ${isEditing ? `
                                <div class="flex flex-col gap-1 flex-1 mr-2">
                                    <div class="flex items-center gap-2">
                                        <input id="edit-input-${task.id}" type="text" value="${escapeHTML(task.text)}" onkeydown="window.handleEditKeyDown(event, '${task.id}')" class="flex-1 w-full min-w-0 bg-white dark:bg-stone-950 border border-stone-300 dark:border-stone-600 rounded-sm px-2 py-1 outline-none focus:ring-1 focus:${th.borderMain} dark:text-white text-sm" />
                                        <button onclick="window.saveEditingTask('${task.id}')" class="text-emerald-600 hover:text-emerald-700 dark:text-emerald-400 p-2 sm:p-1"><i data-lucide="check" class="w-4 h-4"></i></button>
                                        <button onclick="window.cancelEditingTask()" class="text-stone-400 hover:text-rose-500 p-2 sm:p-1"><i data-lucide="x" class="w-4 h-4"></i></button>
                                    </div>
                                    ${editBlockedHtml}
                                </div>
                            ` : `<span class="truncate text-stone-800 dark:text-stone-200 text-sm sm:text-base cursor-pointer hover:${th.textMain}" onclick="window.toggleNotes('${task.id}')">${escapeHTML(task.text)}</span>`}
                            
                            <div class="flex gap-1 items-center shrink-0">
                                <span class="text-[10px] uppercase tracking-wider bg-stone-100 dark:bg-stone-800 border border-stone-200 dark:border-stone-700 text-stone-500 dark:text-stone-400 px-1.5 py-0.5 rounded-sm truncate max-w-[80px] sm:max-w-none">${escapeHTML(tPlate?.name || 'Varios')}</span>
                                ${depBadge}
                                ${isFuture ? `<span class="text-[10px] flex items-center gap-1 uppercase tracking-wider bg-amber-50 dark:bg-amber-900/30 text-amber-700 dark:text-amber-400 border border-amber-200 dark:border-amber-800 px-1.5 py-0.5 rounded-sm shrink-0"><i data-lucide="calendar" class="w-2.5 h-2.5"></i>${task.scheduledDate}</span>` : ''}
                                ${recBadge}
                                ${timeBadge}
                                ${task.notes && !showNotes && !isEditing ? `<i data-lucide="align-left" class="w-3 h-3 text-stone-400 ml-1"></i>` : ''}
                            </div>
                        </div>
                        
                        ${!isEditing ? `
                        <div class="flex items-center justify-end gap-2 shrink-0 pl-10 sm:pl-0 sm:opacity-0 sm:group-hover:opacity-100 transition-opacity">
                            <button onclick="window.toggleNotes('${task.id}')" class="text-stone-400 hover:${th.textMain} p-2 sm:p-1" title="Notas/Subtareas"><i data-lucide="file-text" class="w-4 h-4 sm:w-3.5 sm:h-3.5"></i></button>
                            ${task.status === 'todo' ? `<button onclick="window.startEditingTask('${task.id}', \`${escapeHTML(task.text).replace(/`/g, '\\`')}\`)" class="text-stone-400 hover:${th.textMain} p-2 sm:p-1" title="Editar tarea"><i data-lucide="pencil" class="w-4 h-4 sm:w-3.5 sm:h-3.5"></i></button>` : ''}
                            <button onclick="window.dispatch({type:'DELETE_TASK', payload:'${task.id}'})" class="text-stone-400 hover:text-rose-500 dark:hover:text-rose-400 p-2 sm:p-1" title="Eliminar tarea definitivamente"><i data-lucide="trash-2" class="w-4 h-4 sm:w-3.5 sm:h-3.5"></i></button>
                            ${task.status === 'todo' && task.skipCount >= 3 ? `
                                <span class="text-xs text-rose-600 dark:text-rose-400 bg-rose-50 dark:bg-rose-950/30 px-2 py-1 rounded-sm flex items-center gap-1 border border-rose-100 dark:border-rose-900/50"><i data-lucide="alert-triangle" class="w-3 h-3"></i> Saltada ${task.skipCount}</span>
                                <button onclick="window.dispatch({type:'DISMISS_TASK', payload:'${task.id}'})" class="text-xs text-stone-500 hover:text-rose-600 dark:hover:text-rose-400 underline">Descartar</button>
                            ` : ''}
                        </div>` : ''}
                    </div>
                    ${showNotes ? `
                        <div class="pl-10 sm:pl-8 pr-2 pt-2 pb-1 w-full animate-slide-bottom">
                            <textarea id="notes-area-${task.id}" onblur="window.saveNotes('${task.id}')" class="w-full bg-white dark:bg-stone-950 border border-stone-200 dark:border-stone-700 rounded-sm p-2 text-sm text-stone-600 dark:text-stone-300 outline-none focus:border-stone-400 transition-colors resize-y min-h-[60px]" placeholder="AÃ±ade notas, enlaces o pasos (se guarda al salir)...">${escapeHTML(task.notes)}</textarea>
                        </div>
                    ` : ''}
                </div>`;
            });

            container.innerHTML = `
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-end gap-3 mb-4 pl-2">
                    <div class="flex gap-4 border-b border-stone-200 dark:border-stone-700 w-full sm:w-auto">
                        <button onclick="window.dispatch({type:'SET_LIST_TAB', payload:'all'})" class="pb-2 text-sm font-medium transition-colors ${state.listTab === 'all' ? `${th.textMain} border-b-2 ${th.borderMain}` : 'text-stone-500 hover:text-stone-700 dark:hover:text-stone-300'}">Registro general</button>
                        <button onclick="window.dispatch({type:'SET_LIST_TAB', payload:'agenda'})" class="pb-2 text-sm font-medium transition-colors ${state.listTab === 'agenda' ? `${th.textMain} border-b-2 ${th.borderMain}` : 'text-stone-500 hover:text-stone-700 dark:hover:text-stone-300'}">Agenda programada</button>
                    </div>
                    
                    <div class="flex gap-2 flex-wrap w-full sm:w-auto sm:justify-end">
                        <label class="text-xs text-stone-500 dark:text-stone-400 hover:${th.textMain} flex items-center gap-1 transition-colors px-2 py-2 sm:py-1 rounded-sm hover:bg-stone-200/50 dark:hover:bg-stone-800 cursor-pointer border border-stone-200 dark:border-stone-700 sm:border-transparent flex-1 sm:flex-none justify-center">
                            <i data-lucide="upload" class="w-3.5 h-3.5"></i> TXT
                            <input type="file" accept=".txt" class="hidden" onchange="window.triggerImport(event)" />
                        </label>
                        <button onclick="window.handleExportTxt()" class="text-xs text-stone-500 dark:text-stone-400 hover:${th.textMain} flex items-center gap-1 transition-colors px-2 py-2 sm:py-1 rounded-sm hover:bg-stone-200/50 dark:hover:bg-stone-800 border border-stone-200 dark:border-stone-700 sm:border-transparent flex-1 sm:flex-none justify-center"><i data-lucide="download" class="w-3.5 h-3.5"></i> TXT</button>
                        <button onclick="window.handleExportCSV()" class="text-xs text-stone-500 dark:text-stone-400 hover:text-emerald-600 dark:hover:text-emerald-500 flex items-center gap-1 transition-colors px-2 py-2 sm:py-1 rounded-sm hover:bg-emerald-50 dark:hover:bg-emerald-900/30 border border-stone-200 dark:border-stone-700 sm:border-transparent flex-1 sm:flex-none justify-center" title="Exportar para Excel"><i data-lucide="file-spreadsheet" class="w-3.5 h-3.5"></i> CSV</button>
                        ${hasHistory ? `<button onclick="window.dispatch({type:'CLEAR_HISTORY'})" class="text-xs text-stone-500 dark:text-stone-400 hover:text-rose-600 dark:hover:text-rose-400 flex items-center gap-1 transition-colors px-2 py-2 sm:py-1 rounded-sm hover:bg-rose-50 dark:hover:bg-rose-950/30 border border-stone-200 dark:border-stone-700 sm:border-transparent flex-1 sm:flex-none justify-center"><i data-lucide="trash-2" class="w-3.5 h-3.5"></i> Limpiar</button>` : ''}
                    </div>
                </div>
                <div class="bg-white/80 backdrop-blur-md dark:bg-stone-900/90 border border-stone-200/50 dark:border-stone-800 rounded-lg p-3 sm:p-4 text-sm flex flex-col gap-2 shadow-sm transition-colors duration-200">
                    ${listHtml}
                </div>
            `;
        }

        function buildHeatmapHTML() {
            const th = themeConfig[state.theme || 'autumn'];
            const days = [];
            const today = new Date();
            
            for(let i=34; i>=0; i--) {
                const d = new Date();
                d.setDate(today.getDate() - i);
                const dStr = d.toISOString().split('T')[0];
                const count = state.tasks.filter(t => t.status === 'done' && t.completedAt === dStr).length;
                days.push({ date: dStr, count });
            }
            
            let gridHtml = '';
            days.forEach(d => {
                let intensityClass = 'bg-stone-200 dark:bg-stone-800/80'; 
                if (d.count === 1) intensityClass = th.lightBg + (state.isDarkMode? '' : ' opacity-70');
                else if (d.count === 2) intensityClass = `${th.bgMain} opacity-50`;
                else if (d.count > 2) intensityClass = th.bgMain;
                
                gridHtml += `<div class="w-4 h-4 sm:w-5 sm:h-5 rounded-sm ${intensityClass} transition-colors cursor-help" title="${d.date}: ${d.count} tareas"></div>`;
            });

            return `
                <div class="mt-8 mb-2 flex flex-col items-center w-full overflow-x-auto no-scrollbar">
                    <h4 class="text-[10px] uppercase tracking-wider text-stone-400 dark:text-stone-500 mb-4">Constancia (Ãšltimos 35 dÃ­as)</h4>
                    <div class="grid grid-cols-[repeat(7,minmax(0,1fr))] grid-flow-row gap-1.5 sm:gap-2 auto-cols-max">
                        ${gridHtml}
                    </div>
                </div>
            `;
        }

        function calculateAdvancedStats() {
            const todayStr = getToday();
            const pending = state.tasks.filter(t => t.status === 'todo');
            const done = state.tasks.filter(t => t.status === 'done');
            const doneT = done.length;
            const dismissedT = state.tasks.filter(t => t.status === 'dismissed').length;
            const doneToday = done.filter(t => t.completedAt === todayStr).length;

            const discardRate = doneT + dismissedT > 0 ? Math.round((dismissedT / (doneT + dismissedT)) * 100) : 0;
            const friction = state.stats.selectYes > 0 ? (state.stats.selectNo / state.stats.selectYes).toFixed(1) : 0;
            const avgSkips = pending.length > 0 ? (pending.reduce((a, t) => a + t.skipCount, 0) / pending.length).toFixed(1) : 0;
            const atRisk = pending.filter(t => t.skipCount >= 2).length;
            const maxChain = state.stats.maxChain || 0;
            
            const doneByPlate = done.reduce((acc, t) => { acc[t.plateId] = (acc[t.plateId] || 0) + 1; return acc; }, {});
            const mostActivePlateId = Object.keys(doneByPlate).sort((a,b) => doneByPlate[b] - doneByPlate[a])[0];
            const mostActivePlateName = state.plates.find(p => p.id === mostActivePlateId)?.name || 'Ninguno';
            
            const neglectedPlate = [...state.plates].sort((a,b) => (a.lastActionDate || '') < (b.lastActionDate || '') ? -1 : 1)[0];
            const neglectedPlateName = neglectedPlate?.name || 'Ninguno';
            
            const greenPlatesCount = state.plates.filter(p => p.lastActionDate === todayStr).length;
            const balanceRate = state.plates.length > 0 ? Math.round((greenPlatesCount / state.plates.length) * 100) : 0;
            
            const doneTodayByPlate = done.filter(t => t.completedAt === todayStr).reduce((acc, t) => { acc[t.plateId] = (acc[t.plateId] || 0) + 1; return acc; }, {});
            const maxDTPlateId = Object.keys(doneTodayByPlate).sort((a,b) => doneTodayByPlate[b] - doneTodayByPlate[a])[0];
            const concentration = doneToday > 0 && maxDTPlateId ? Math.round((doneTodayByPlate[maxDTPlateId] / doneToday) * 100) : 0;
            
            const pomsToday = state.stats.pomodoroDate === todayStr ? state.stats.pomodorosToday : 0;
            const focusMinutes = state.stats.pomodoroDate === todayStr ? state.stats.pomodoroMinutesToday : 0;
            const timePerTask = doneToday > 0 ? Math.round(focusMinutes / doneToday) : 0;
            
            const pomsByPlate = state.stats.pomodoroMinutesByPlate || {};
            const mostFocusedPlateId = Object.keys(pomsByPlate).sort((a,b) => pomsByPlate[b] - pomsByPlate[a])[0];
            const mostFocusedPlateName = state.plates.find(p => p.id === mostFocusedPlateId)?.name || 'Ninguno';
            
            const addedToday = state.tasks.filter(t => new Date(t.createdAt).toISOString().split('T')[0] === todayStr).length;
            const captureExecution = doneToday > 0 ? (addedToday / doneToday).toFixed(1) : addedToday;
            
            const avgAgeDays = pending.length > 0 ? Math.round(pending.reduce((a, t) => a + (Date.now() - t.createdAt), 0) / pending.length / (1000 * 60 * 60 * 24)) : 0;
            
            const streak = getStreak();
            const reenteredTodayCount = state.stats.reenteredDate === todayStr ? state.stats.reenteredToday : 0;
            
            const daysOfWeek = ['Dom', 'Lun', 'Mar', 'MiÃ©', 'Jue', 'Vie', 'SÃ¡b'];
            const dayCounts = new Array(7).fill(0);
            done.forEach(t => { if (t.completedAt) dayCounts[new Date(t.completedAt).getDay()]++; });
            const bestDayName = Math.max(...dayCounts) > 0 ? daysOfWeek[dayCounts.indexOf(Math.max(...dayCounts))] : 'N/A';
            
            const sevenDaysAgo = getFutureDate(-7);
            const doneLast7Days = done.filter(t => t.completedAt && t.completedAt >= sevenDaysAgo).length;

            return [
                { l: "Tasa descarte", v: `${discardRate}%` }, { l: "Fricc. selecciÃ³n", v: `${friction}` },
                { l: "Saltos prom.", v: avgSkips }, { l: "Tareas riesgo", v: atRisk },
                { l: "Cadena mÃ¡x.", v: maxChain }, { l: "Plato + activo", v: mostActivePlateName },
                { l: "Plato olvidado", v: neglectedPlateName }, { l: "Equilibrio", v: `${balanceRate}%` },
                { l: "Foco hoy", v: `${concentration}%` }, { l: "Platos activos", v: greenPlatesCount },
                { l: "Pomodoros hoy", v: pomsToday }, { l: "Tiempo total", v: `${focusMinutes}m` },
                { l: "Tiempo/tarea", v: `${timePerTask}m` }, { l: "Plato + tiempo", v: mostFocusedPlateName },
                { l: "Capt./Ejec.", v: `${captureExecution}x` }, { l: "Edad lista", v: `${avgAgeDays}d` },
                { l: "Racha prod.", v: `${streak}d` }, { l: "Reingresos", v: reenteredTodayCount },
                { l: "DÃ­a fuerte", v: bestDayName }, { l: "Ãšlt. 7 dÃ­as", v: doneLast7Days }
            ];
        }

        function renderStats() {
            const th = themeConfig[state.theme || 'autumn'];
            const container = document.getElementById('stats-section');
            container.style.display = state.zenMode ? 'none' : 'block'; 
            if (state.zenMode) return;

            const todayStr = getToday();
            const doneT = state.tasks.filter(t => t.status === 'done').length;
            const doneToday = state.tasks.filter(t => t.status === 'done' && t.completedAt === todayStr).length;
            const pendingT = state.tasks.filter(t => t.status === 'todo').length;
            const disT = state.tasks.filter(t => t.status === 'dismissed').length;

            let advHtml = '';
            if (showAdvancedStats) {
                const adv = calculateAdvancedStats();
                advHtml = `<div class="grid grid-cols-2 sm:grid-cols-4 lg:grid-cols-5 gap-2 sm:gap-3 mt-4 animate-slide-top">
                    ${adv.map(s => `
                        <div class="bg-white/80 backdrop-blur-md dark:bg-stone-900/90 border border-stone-200/50 dark:border-stone-800 p-3 rounded-lg shadow-sm flex flex-col items-center text-center justify-center h-20 hover:border-stone-300 dark:hover:border-stone-700 transition-colors">
                            <span class="text-base sm:text-lg font-semibold text-stone-900 dark:text-white leading-none mb-1.5 truncate w-full px-1">${s.v}</span>
                            <span class="text-[8px] sm:text-[9px] uppercase tracking-wider text-stone-500 leading-tight">${s.l}</span>
                        </div>
                    `).join('')}
                </div>`;
            }

            // Feature 10: Diario / ReflexiÃ³n
            const journalText = state.journal[todayStr] || '';
            const journalHtml = `
                <div class="mt-8 bg-white/80 backdrop-blur-md dark:bg-stone-900/90 border border-stone-200/50 dark:border-stone-800 rounded-lg p-5 shadow-sm">
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="text-xs uppercase tracking-widest text-stone-500 dark:text-stone-400 font-semibold flex items-center gap-2">
                            <i data-lucide="book-open" class="w-3.5 h-3.5"></i> Diario de enfoque
                        </h3>
                        <span class="text-[10px] text-stone-400">${todayStr}</span>
                    </div>
                    ${showJournalInput ? `
                        <textarea id="journal-input" class="w-full bg-stone-50 dark:bg-stone-950 border border-stone-200 dark:border-stone-800 rounded-sm p-3 text-sm text-stone-700 dark:text-stone-300 outline-none focus:ring-1 focus:${th.borderMain} transition-colors resize-y min-h-[80px]" placeholder="Â¿CÃ³mo te sentiste hoy? Â¿En quÃ© lograste avanzar?">${escapeHTML(journalText)}</textarea>
                        <div class="flex gap-2 mt-2">
                            <button onclick="window.saveJournal()" class="px-4 py-2 ${th.bgMain} text-white text-xs rounded-sm hover:opacity-90">Guardar reflexiÃ³n</button>
                            <button onclick="showJournalInput=false; renderStats();" class="px-4 py-2 border border-stone-200 dark:border-stone-700 text-stone-500 text-xs rounded-sm">Cancelar</button>
                        </div>
                    ` : `
                        ${journalText ? `<p class="text-sm text-stone-700 dark:text-stone-300 italic border-l-2 ${th.borderMain} pl-3 py-1 bg-stone-50/50 dark:bg-stone-800/30">"${escapeHTML(journalText)}"</p>` : `<p class="text-sm text-stone-400 italic">AÃºn no has escrito nada hoy.</p>`}
                        <button onclick="showJournalInput=true; renderStats(); setTimeout(()=>document.getElementById('journal-input').focus(),10);" class="mt-3 text-xs ${th.textMain} hover:underline font-medium">
                            ${journalText ? 'Editar reflexiÃ³n' : 'Escribir reflexiÃ³n de hoy...'}
                        </button>
                    `}
                </div>
            `;

            container.innerHTML = `
                <h3 class="text-xs uppercase tracking-widest text-stone-400 dark:text-stone-500 mb-4 pl-2 flex items-center gap-2"><i data-lucide="bar-chart-2" class="w-3.5 h-3.5"></i> EstadÃ­sticas</h3>
                <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 sm:gap-4 mb-4">
                    <div class="bg-white/80 backdrop-blur-md dark:bg-stone-900/90 border border-stone-200/50 dark:border-stone-800 p-4 rounded-lg shadow-sm flex flex-col items-center justify-center">
                        <span class="text-3xl font-semibold ${th.textMain}">${doneToday}</span>
                        <span class="text-[10px] uppercase tracking-wider text-stone-500 mt-1">Completadas hoy</span>
                    </div>
                    <div class="bg-white/80 backdrop-blur-md dark:bg-stone-900/90 border border-stone-200/50 dark:border-stone-800 p-4 rounded-lg shadow-sm flex flex-col items-center justify-center">
                        <span class="text-3xl font-semibold text-amber-600 dark:text-amber-500">${doneT}</span>
                        <span class="text-[10px] uppercase tracking-wider text-stone-500 mt-1">Completadas total</span>
                    </div>
                    <div class="bg-white/80 backdrop-blur-md dark:bg-stone-900/90 border border-stone-200/50 dark:border-stone-800 p-4 rounded-lg shadow-sm flex flex-col items-center justify-center">
                        <span class="text-3xl font-semibold text-stone-700 dark:text-stone-300">${pendingT}</span>
                        <span class="text-[10px] uppercase tracking-wider text-stone-500 mt-1">Pendientes</span>
                    </div>
                    <div class="bg-white/80 backdrop-blur-md dark:bg-stone-900/90 border border-stone-200/50 dark:border-stone-800 p-4 rounded-lg shadow-sm flex flex-col items-center justify-center">
                        <span class="text-3xl font-semibold text-rose-600 dark:text-rose-400">${disT}</span>
                        <span class="text-[10px] uppercase tracking-wider text-stone-500 mt-1">Descartadas</span>
                    </div>
                </div>
                
                <div class="bg-white/80 backdrop-blur-md dark:bg-stone-900/90 border border-stone-200/50 dark:border-stone-800 rounded-lg p-4 shadow-sm mb-4">
                    ${buildHeatmapHTML()}
                </div>

                <button onclick="showAdvancedStats=!showAdvancedStats; renderStats(); lucide.createIcons();" class="w-full h-12 flex items-center justify-center gap-2 p-3 text-sm text-stone-500 hover:${th.textMain} transition-colors border border-transparent hover:border-stone-200 dark:hover:border-stone-800 rounded-lg bg-white/80 backdrop-blur-md dark:bg-stone-900/90 shadow-sm">
                    <i data-lucide="${showAdvancedStats ? 'chevron-up' : 'chevron-down'}" class="w-4 h-4"></i>
                    ${showAdvancedStats ? 'Ocultar mÃ©tricas avanzadas' : 'Ver 20 mÃ©tricas avanzadas'}
                </button>
                ${advHtml}

                ${journalHtml}
            `;
        }

        // --- INICIALIZADOR ---
        function renderApp() {
            renderHeader();
            renderPlates();
            renderPhase();
            renderList();
            renderStats();
            lucide.createIcons();
            document.documentElement.classList.toggle('dark', state.isDarkMode);
        }

        // Bind keyboard shortcuts
        window.addEventListener('keydown', (e) => {
            if (state.mode === 'select' && editingTaskId === null) {
                if (e.key === 'ArrowRight') window.handleSelectYes();
                else if (e.key === 'ArrowDown') window.handleSelectNo();
            }
        });

        // Inicio automÃ¡tico
        window.onload = () => {
            loadState();
            renderApp();
            if ("Notification" in window && Notification.permission === "default") {
                Notification.requestPermission();
            }
        };
    </script>
</body>
</html>
